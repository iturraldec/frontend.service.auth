import { useEffect, useState } from 'react';
import MyToast from 'components/myToast';
import Swal from 'sweetalert2'
import withReactContent from 'sweetalert2-react-content'
import useFetch from 'hooks/useFetch';
import PermissionsListView from './permissionsListView';
import PermissionsModalView from './permissionsModalView';

//
function getUrl(page) {
  return `http://localhost:8000/api/permissions?page=${page}`;
};

//
const emptyPermission = {
  id: '',
  name: '',
  slug: ''
};

//
const emptyPage = {
  url: '',
  current: 0,
  total: 0
};

//
export default function Permissions() {
  const [page, setPage]               = useState(emptyPage);
  const [permission, setPermission]   = useState(emptyPermission);
  const {fetchState, getData}         = useFetch();
  const [showModal, setShowModal]     = useState(false);
  const [message, setMessage]         = useState('');

  //
  useEffect(() => {
    handleChangePage(1);
  }, []);

  //
  useEffect(() => {
    if(fetchState.state === 'success') {
      setPage(oldValue => ({
        ...oldValue, 
        current: fetchState.data.data.current_page,
        total: fetchState.data.data.last_page
      }));
    }
  }, [page]);

  //
  function handleChangeName(e) {
    let texto = e.target.value.toUpperCase();

    setPermission(oldValue => ({
      ...oldValue,
      name: texto,
      slug: texto.replace(/ /g, "-").toLowerCase()
    }));
  }

  //
  function handleCreate () {
    setPermission(emptyPermission);
    setShowModal(true);
  };

  //
  function handleUpdate(permission) {
    setPermission({
      id: permission.id,
      name: permission.name,
      slug: permission.slug
    });
    setShowModal(true);
  };

  //
  function handleSubmit(event) {
    event.preventDefault();

    if (permission.id === '') {
      fetch('http://localhost:8000/api/permissions',{
        method: 'post',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(permission)
      });

      setMessage("Permiso agregado...");
    }
    else {
       fetch(`http://localhost:8000/api/permissions/${permission.id}`,{
        method: 'put',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(permission)
      });

      setMessage("Permiso actualizado...");
    }
    setShowModal(false);
    reload();
  }

  //
  function handleDelete(_id) {
    withReactContent(Swal).fire({
      title: "Seguro de ELIMINAR el permiso y sus relaciones?",
      text: "No podras revertir esta acción!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33",
      confirmButtonText: "Si, eliminalo!",
      cancelButtonText: "Cancelar"
    })
    .then((result) => {
      if (result.isConfirmed) {
        deletePermission(_id);
      } 
    });
  }

  //
  async function deletePermission(_id) {
    await fetch(`http://localhost:8000/api/permissions/${_id}`,{
                method: 'delete',
                headers: {
                  'Accept': 'application/json'
         }
    });
    reload();
    setMessage("Permiso eliminado...");
  }
import { useEffect, useState } from "react";
import MyToast from "components/myToast";
import Swal from 'sweetalert2'
import withReactContent from 'sweetalert2-react-content'
import useFetch from "hooks/useFetch";
import PermissionsListView from "./permissionsListView";
import PermissionsModalView from "./permissionsModalView";

//
const emptyPermission = {
  id: '',
  name: '',
  slug: ''
};

//
export default function Permissions() {
  const [permission,setPermission]  = useState(emptyPermission);
  const [permissions,setPermissions]= useState(null);
  const [showModal,setShowModal]    = useState(false);
  const [message,setMessage]        = useState('');
  let {state,
       data,
       getData,
       deleteData
      }                             = useFetch();
  
  //
  useEffect(() => {
    getData('http://localhost:8000/api/permissions?page=1');
  }, []);

  //
  useEffect(() => {
    switch(state){
      case 'loading':
        setMessage('Cargando permisos...');
        break;
      case 'adding':
        setMessage('Agregando permisos...');
        break;
      case 'updating':
        setMessage('Actualizando permisos...');
        break;
      case 'removing':
        setMessage('Eliminando permisos...');
        break;
      default:
        handleCloseMessage();
        break;
    };
  }, [state]);

  //
  useEffect(() => {
    if(data !==null && data.data !== null && data.data.hasOwnProperty('current_page')) {
      setPermissions({...data.data});
    }
  }, [data]);

  //
  function handleCloseModal(){
    setShowModal(false);
  }

  //
  function handleCloseMessage(){
    setMessage('');
  };

  //
  function handleCreate(){
    setPermission(emptyPermission);
    setShowModal(true);
  }
  
  //
  function handleUpdate(){

  };

  //
  async function handleSubmit(event){
    event.preventDefault();

    if (permission.id === '') {
      await fetchData('http://localhost:8000/api/permissions',{
              method: 'post',
              headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(permission)
            });
    }
    else {
      await fetchData(`http://localhost:8000/api/permissions/${permission.id}`,{
              method: 'put',
              headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(permission)
            });
    };

    setShowModal(false);
    reload();
  }

  //
  async function handleDelete(id) {
    // await withReactContent(Swal).fire({
    //   title: "Seguro de ELIMINAR el permiso y sus relaciones?",
    //   text: "No podras revertir esta acción!",
    //   icon: "warning",
    //   showCancelButton: true,
    //   confirmButtonColor: "#3085d6",
    //   cancelButtonColor: "#d33",
    //   confirmButtonText: "Si, eliminalo!",
    //   cancelButtonText: "Cancelar"
    // })
    // .then((result) => {
    //   if (result.isConfirmed) {
    //     permissionDelete(id);
    //   }
    // })
    permissionDelete(id);
  }

  //
  function permissionDelete(id){
    console.log("borre");
    fetchData(`http://localhost:8000/api/permissions/${id}`,{
                method: 'delete',
                headers: {
                  'Accept': 'application/json'
                }
          });
    
          console.log(response);
    if(response.ok) reload();
  } 

  //
  function handleChangeName(event){
    let texto = event.target.value.toUpperCase();

    setPermission(oldValue => ({
      ...oldValue,
      name: texto,
      slug: texto.replace(/ /g, "-").toLowerCase()
    }));
  }

  //
  function handleChangePage(url){
    fetchData(url);
  };

  //
  function reload(){
    fetchData(permissions.links.find(item => item.active).url);
  }

  //
  return (
    <>
      <MyToast message={message} handleCloseMessage={handleCloseMessage} />

      { permissions !== null && <PermissionsListView 
        permissions={permissions}
        handleCreate={handleCreate}
        handleUpdate={handleUpdate}
        handleDelete={handleDelete}
        handleChangePage={handleChangePage}
      />}

      <PermissionsModalView 
        show={showModal}
        handleCloseModal={handleCloseModal}
        handleSubmit={handleSubmit}
        permission={permission}
        handleChangeName={handleChangeName}
      />
    </>
  );
}